---
# Variable defaults file for avinetworks.avise

# parameters for use when deploying as package
package_deploy: false
package_source: controller_docker.tgz
package_dest: /tmp/controller_docker.tgz

# parameters for use when pulling from docker hub or docker repo
docker_repo: ~
se_version: latest
se_image: "avinetworks/se:{{ se_version }}"

# standard parameters
se_version: latest
se_cores: "{{ ansible_processor_cores }}"
se_memory_gb: "{{ ansible_memtotal_mb / 1024 }}"
destination_disk: "{{ ansible_mounts|sort(reverse=True, attribute='size_total')|map(attribute='mount')|first}}"
se_disk_path: "{{ destination_disk }}opt/avi/se/data"
se_disk_gb: 10
se_logs_disk_path: ~
se_logs_disk_gb: ~
master_ctl_ip: ~
autoregister: true
master_ctl_username: ~
master_ctl_password: ~


# DPDK Variables which handle how DPDK is started and ran.
dpdk: false
dpdk_pre: >
  rmmod igb_uio; rmmod rte_kni; modprobe uio; insmod /opt/avi/kmod/igb_uio.ko;
  insmod /opt/avi/kmod/rte_kni.ko; mkdir -p /mnt/huge; umount /mnt/huge; rm /mnt/huge/*;
  mount -t hugetlbfs nodev /mnt/huge
dpdk_post: "rmmod igb_uio; rmmod rte_kni; umount /mnt/huge"

# Mount variables which are sent to the docker container, these are used in the service templates.
mounts_extras: []
mounts_default:
  - "/mnt:/mnt"
  - "/dev:/dev"
  - "/etc/sysconfig/network-scripts:/etc/sysconfig/network-scripts"
  - "/:/hostroot/"
  - "/etc/hostname:/etc/host_hostname"
  - "/etc/localtime:/etc/localtime"
  - "/var/run/docker.sock:/var/run/docker.sock"
  - "{{ (se_disk_path == None) | ternary('', se_disk_path ~ ':/vol/') }}"
  - "{{ (se_logs_disk_path == None) | ternary('', se_logs_disk_path ~ ':/vol_logs/') }}"
mounts_all: "{{ mounts_extras + mounts_default}}"
mounts_string: "{% for mount_var in mounts_all|reject('match', '^$') %} -v {{ mount_var }}{% endfor %}"

# Environment variables which are sent to the docker container, these are used in the service templates.
env_variables_extras: []
env_variables_default:
  - "CONTAINER_NAME=avise"
  - "CONTROLLERIP={{ master_ctl_ip | string }}"
  - "NTHREADS={{ se_cores|int }}"
  - "SEMEMMB={{ se_memory_gb|int * 1024 }}"
  - "{{ dpdk | ternary('DOCKERNETWORKMODE=HOST_DPDK', 'DOCKERNETWORKMODE=HOST') }}"
  - "{{ (se_disk_gb == None) | ternary('', 'DISKSZ=' + ( se_disk_gb|int * 1024 )|string ) }}"
  - "{{ (se_logs_disk_gb == None) | ternary('', 'LOG_DISKSZ=' + ( se_logs_disk_gb|int * 1024 )|string ) }}"
env_variables_all: "{{ env_variables_extras + env_variables_default }}"
env_variables_string: "{% for env_var in env_variables_all|reject('match', '^$') %} -e {{ env_var }}{% endfor %}"

# !!!! BEWARE: This is to completely override everything passed into the service template for the docker run. DON'T EDIT THIS UNLESS YOU KNOW WHAT YOUR DOING!!!!!
docker_run_params: "--name=avise -d {{ env_variables_string }} --net=host {{ mounts_string }} --privileged=true {{ se_image }}"
