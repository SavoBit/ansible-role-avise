---
# We must do this step first just in case we need to override defaults from the supplied package
- name: Avi SE | Docker | Package Deploy
  include: package_deploy.yml
  when: package_deploy

- name: Avi SE | Docker | Check if specified image already exists.
  shell: "docker images -q {{ se_image }}"
  changed_when: false
  register: docker_match

- name: Avi SE | Docker | Docker Hub
  include: docker_hub.yml
  when: docker_repo == None and not package_deploy

- name: Avi SE | Docker | Custom Repo
  include: custom_repo.yml
  when: docker_repo != None and not package_deploy

- name: Avi SE | Service | Set service fact for deploy
  set_fact:
    old_service: "{{ se_version|version_compare('17.0.0', '<') or se_version == 'latest' }}"
    new_service: "{{ se_version|version_compare('17.0.0', '>=') }}"

- name: Avi SE | Docker | Check if specified image already exists.
  shell: "docker images -q {{ se_image }}"
  changed_when: false
  register: docker_match

- name: Avi SE | Docker | Get our desired docker image id.
  shell: "docker images -q {{ se_image }}"
  changed_when: false
  register: docker_image

- name: Avi SE | Docker | Get list of running se containers
  shell: "docker ps -q -f name=avise"
  changed_when: false
  register: running_se_containers

- name: Avi SE | Docker | Check if desired version is already running.
  shell: "docker ps -q -f ancestor={{ docker_image.stdout }}"
  changed_when: false
  register: desired_running
